<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JWT Tool</title>
    <style>
        :root {
            --header-bg: #fb015b15;
            --payload-bg: #d63aff15;
            --signature-bg: #00f5d415;
            --primary-color: #007acc;
            --error-color: #ff4444;
            --success-color: #4caf50;
            --border-color: #ccc;
        }

        body {
            padding: 20px;
            color: var(--vscode-foreground);
            font-family: var(--vscode-font-family);
            background-color: var(--vscode-editor-background);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 20px;
        }

        .mode-switch {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background: none;
            color: var(--vscode-foreground);
            cursor: pointer;
            border-radius: 4px;
        }

        .mode-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .input-container {
            position: relative;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            font-family: var(--vscode-editor-font-family);
            font-size: 13px;
            resize: vertical;
            box-sizing: border-box;
        }

        .jwt-part {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .jwt-header { background-color: var(--header-bg); }
        .jwt-payload { background-color: var(--payload-bg); }
        .jwt-signature { background-color: var(--signature-bg); }

        .button-container {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        button {
            padding: 6px 12px;
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: var(--vscode-button-hoverBackground);
        }

        .copy-btn {
            padding: 4px 8px;
            font-size: 12px;
        }

        .validation-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .valid {
            background-color: color-mix(in srgb, var(--success-color) 20%, transparent);
            color: var(--success-color);
        }

        .invalid {
            background-color: color-mix(in srgb, var(--error-color) 20%, transparent);
            color: var(--error-color);
        }

        .error {
            color: var(--error-color);
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            background-color: color-mix(in srgb, var(--error-color) 10%, transparent);
        }

        .hidden {
            display: none;
        }

        select, input[type="text"] {
            padding: 6px;
            background-color: var(--vscode-dropdown-background);
            color: var(--vscode-dropdown-foreground);
            border: 1px solid var(--vscode-dropdown-border);
            border-radius: 4px;
        }

        input[type="text"] {
            width: 100%;
            box-sizing: border-box;
            margin: 5px 0;
        }

        pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .timestamp {
            font-size: 12px;
            color: var(--vscode-descriptionForeground);
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="mode-switch">
            <button class="mode-btn active" id="decodeBtn">Decode</button>
            <button class="mode-btn" id="encodeBtn">Encode</button>
        </div>

        <!-- Decode Mode -->
        <div id="decodeMode">
            <div class="section">
                <div class="section-title">JWT Token</div>
                <textarea id="jwtInput" placeholder="Paste your JWT token here..."></textarea>
                <div class="button-container">
                    <button id="decodeButton">Decode</button>
                    <button id="validateButton">Validate</button>
                </div>
                <input type="text" id="secretInput" class="hidden" placeholder="Enter secret for validation...">
            </div>
            
            <div id="validation-status" class="hidden"></div>
            
            <div id="decoded-sections" class="hidden">
                <div class="jwt-part jwt-header">
                    <div class="section-title">
                        HEADER
                        <button class="copy-btn" onclick="copySection('header')">Copy</button>
                    </div>
                    <pre id="headerData"></pre>
                </div>
                
                <div class="jwt-part jwt-payload">
                    <div class="section-title">
                        PAYLOAD
                        <button class="copy-btn" onclick="copySection('payload')">Copy</button>
                    </div>
                    <pre id="payloadData"></pre>
                    <div id="timestamp-data" class="timestamp"></div>
                </div>
                
                <div class="jwt-part jwt-signature">
                    <div class="section-title">
                        SIGNATURE
                        <button class="copy-btn" onclick="copySection('signature')">Copy</button>
                    </div>
                    <pre id="signatureData"></pre>
                </div>
            </div>
        </div>

        <!-- Encode Mode -->
        <div id="encodeMode" class="hidden">
            <div class="section">
                <div class="section-title">Header</div>
                <textarea id="headerInput" placeholder="Enter header JSON...">{"alg": "HS256", "typ": "JWT"}</textarea>
                <button onclick="formatJson('headerInput')">Format JSON</button>
            </div>

            <div class="section">
                <div class="section-title">Payload</div>
                <textarea id="payloadInput" placeholder="Enter payload JSON..."></textarea>
                <button onclick="formatJson('payloadInput')">Format JSON</button>
            </div>

            <div class="section">
                <div class="section-title">Signing</div>
                <select id="algorithmSelect" onchange="updateAlgorithm()">
                    <option value="HS256">HS256</option>
                    <option value="HS384">HS384</option>
                    <option value="HS512">HS512</option>
                </select>
                <input type="text" id="encodeSecretInput" placeholder="Enter secret...">
            </div>

            <div class="button-container">
                <button id="encodeButton">Encode</button>
            </div>

            <div id="encoded-output" class="section hidden">
                <div class="section-title">
                    Encoded JWT
                    <button class="copy-btn" id="copyEncoded">Copy</button>
                </div>
                <textarea id="encodedOutput" readonly></textarea>
            </div>
        </div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        let activeMode = 'decode';
        
        // Mode switching
        document.getElementById('decodeBtn').addEventListener('click', () => switchMode('decode'));
        document.getElementById('encodeBtn').addEventListener('click', () => switchMode('encode'));

        function switchMode(mode) {
            activeMode = mode;
            document.getElementById('decodeMode').classList.toggle('hidden', mode !== 'decode');
            document.getElementById('encodeMode').classList.toggle('hidden', mode !== 'encode');
            document.getElementById('decodeBtn').classList.toggle('active', mode === 'decode');
            document.getElementById('encodeBtn').classList.toggle('active', mode === 'encode');
        }

        // Decode functionality
        document.getElementById('decodeButton').addEventListener('click', () => {
            const token = document.getElementById('jwtInput').value.trim();
            const secret = document.getElementById('secretInput').value.trim();
            if (token) {
                vscode.postMessage({
                    command: 'decode',
                    token,
                    secret: secret || undefined
                });
            }
        });

        document.getElementById('validateButton').addEventListener('click', () => {
            const secretInput = document.getElementById('secretInput');
            secretInput.classList.toggle('hidden');
            if (!secretInput.classList.contains('hidden') && secretInput.value) {
                document.getElementById('decodeButton').click();
            }
        });

        // Encode functionality
        document.getElementById('encodeButton').addEventListener('click', () => {
            const header = document.getElementById('headerInput').value;
            const payload = document.getElementById('payloadInput').value;
            const secret = document.getElementById('encodeSecretInput').value;
            
            if (header && payload && secret) {
                vscode.postMessage({
                    command: 'encode',
                    header,
                    payload,
                    secret
                });
            }
        });

        function updateAlgorithm() {
            const alg = document.getElementById('algorithmSelect').value;
            let headerInput = document.getElementById('headerInput');
            try {
                const header = JSON.parse(headerInput.value);
                header.alg = alg;
                headerInput.value = JSON.stringify(header, null, 2);
            } catch (e) {
                headerInput.value = JSON.stringify({ alg, typ: "JWT" }, null, 2);
            }
        }

        // Utility functions
        function copySection(section) {
            const element = document.getElementById(section + 'Data');
            if (element) {
                navigator.clipboard.writeText(element.textContent).then(() => {
                    const btn = element.previousElementSibling.querySelector('.copy-btn');
                    btn.textContent = 'Copied!';
                    setTimeout(() => btn.textContent = 'Copy', 1500);
                });
            }
        }

        document.getElementById('copyEncoded')?.addEventListener('click', () => {
            const text = document.getElementById('encodedOutput').value;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('copyEncoded');
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = 'Copy', 1500);
            });
        });

        function formatJson(elementId) {
            const text = document.getElementById(elementId).value;
            vscode.postMessage({
                command: 'formatJson',
                text,
                section: elementId
            });
        }

        // Handle messages from extension
        window.addEventListener('message', event => {
            const message = event.data;

            switch (message.command) {
                case 'decodedJWT':
                    displayDecodedJWT(message.decoded);
                    showValidationStatus(message.decoded.is_valid);
                    document.getElementById('decoded-sections').classList.remove('hidden');
                    break;
                    
                case 'encodedJWT':
                    displayEncodedJWT(message.token);
                    break;
                    
                case 'formatResult':
                    document.getElementById(message.section).value = message.text;
                    break;
                    
                case 'error':
                    showError(message.text);
                    break;
            }
        });

        function displayDecodedJWT(decoded) {
            document.getElementById('headerData').textContent = 
                JSON.stringify(decoded.header, null, 2);
            document.getElementById('payloadData').textContent = 
                JSON.stringify(decoded.payload, null, 2);
            document.getElementById('signatureData').textContent = 
                decoded.signature;

            // Display timestamps if available
            const timestamps = [];
            if (decoded.payload.exp) {
                timestamps.push(`Expires: ${decoded.payload.expiry_readable}`);
            }
            if (decoded.payload.iat) {
                timestamps.push(`Issued: ${decoded.payload.issued_at_readable}`);
            }
            if (decoded.payload.nbf) {
                timestamps.push(`Not Before: ${decoded.payload.not_before_readable}`);
            }

            document.getElementById('timestamp-data').textContent = 
                timestamps.join(' | ');
        }

        function displayEncodedJWT(token) {
            const output = document.getElementById('encodedOutput');
            output.value = token;
            document.getElementById('encoded-output').classList.remove('hidden');
        }

        function showValidationStatus(isValid) {
            const statusDiv = document.getElementById('validation-status');
            statusDiv.textContent = isValid ? 'Signature is valid' : 'Invalid signature';
            statusDiv.className = 'validation-status ' + (isValid ? 'valid' : 'invalid');
            statusDiv.classList.remove('hidden');
        }

        function showError(message) {
            const container = document.querySelector('.container');
            const existingError = document.querySelector('.error');
            if (existingError) {
                existingError.remove();
            }
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            container.insertBefore(errorDiv, container.firstChild);
            
            setTimeout(() => errorDiv.remove(), 3000);
        }
    </script>
</body>
</html>